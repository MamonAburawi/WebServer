# Stage 1: Build the application using a modern, container-friendly Gradle version
FROM gradle:8.9-jdk22-alpine AS build

# Set the working directory
WORKDIR /app

# Copy the entire project context into the container
COPY . .

# Run the shadowJar task specifically on your 'server' module to create the fat JAR.
# The --no-daemon flag is recommended for CI/CD environments.
RUN gradle :server:shadowJar --no-daemon

# Stage 2: Create the final, lightweight runtime image from a secure JRE
FROM amazoncorretto:22-alpine-jre

# Set the working directory in the final image
WORKDIR /app

# Copy only the built JAR file from the correct path in the build stage
COPY --from=build /app/server/build/libs/server-all.jar .

# Expose the port your Ktor application will run on
EXPOSE 8080

# The command to run your application
ENTRYPOINT ["java", "-jar", "server-all.jar"]
